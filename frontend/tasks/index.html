<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генерация конспекта | Список заданий</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body>
    <div class="modal" tabindex="-1" id="errorModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ошибка в задании <span id="errorTaskId" class="text-danger"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="errorText" class="text-danger"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-light d-flex flex-column align-items-center vh-100">
        <a href="/" class="btn btn-outline-primary position-absolute top-0 end-0 m-2"
            role="button">Создать конспект</a>
        <h2 class="my-4">Список заданий</h2 class="m">
        <table class="table w-75 table-hover table-bordered" id="tasksTable">
            <thead>
                <tr>
                    <th scope="col">Дата создания</th>
                    <th scope="col">ID</th>
                    <th scope="col">Название</th>
                    <th scope="col">Видео</th>
                    <th scope="col">Статус</th>
                    <th scope="col">PDF</th>
                    <th scope="col">Сообщение</th>
                </tr>
            </thead>
            <tbody class="table-group-divider" id="tasksTableBody">
            </tbody>
        </table>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <script>
        function getStatusBadge(status) {
            const statusMap = {
                'queued': { class: 'secondary', text: 'В очереди' },
                'processing': { class: 'warning', text: 'В обработке' },
                'completed': { class: 'success', text: 'Успешно завершено' },
                'error': { class: 'danger', text: 'Ошибка' }
            };

            const statusInfo = statusMap[status];
            return `<span class="badge text-bg-${statusInfo.class}">${statusInfo.text}</span>`;
        }

        function getDownloadButton(task) {
            if (task.status === 'completed') {
                return `<a href="/pdf/download/${task.id}" download="${task.title}.pdf"><button type="button" class="btn btn-outline-primary py-0">Скачать</button></a>`;
            }

            return '';
        }

        function showErrorMessage(id, message) {
            document.getElementById('errorTaskId').textContent = id;
            document.getElementById('errorText').textContent = message;

            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();

            window.currentErrorTaskId = id;
        }

        function getShowErrorButton(task) {
            if (task.status === 'error' && task.errorMessage) {
                return `<button type="button" class="btn btn-outline-danger py-0" onclick="showErrorMessage('${task.id}', '${task.errorMessage}')">Показать</button>`;
            }

            return '';
        }

        function renderTable(tasks) {
            const tableBody = document.getElementById('tasksTableBody');

            if (tasks.length === 0) {
                return;
            }



            tableBody.innerHTML = tasks.map(task => `
                <tr>
                    <td>${task.createdAt}</th>
                    <td>${task.id}</td>
                    <td>${task.title}</td>
                    <td>
                         <p><a href="${task.videoUrl}"
                                class="link-info link-offset-2 link-underline-opacity-25 link-underline-opacity-75-hover">Ссылка</a>
                        </p>
                    </td>
                    <td>${getStatusBadge(task.status)}</td>
                    <td>${getDownloadButton(task)}</td>
                    <td>${getShowErrorButton(task)}</td>
                </tr>
            `).join('');
        }

        async function loadTasks() {
            const response = await fetch('/task/getAll', {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })

            if (!response.ok) {
                console.error("Ошибка при получении данных");
                return;
            }
            
            const tasks = await response.json();

            renderTable(tasks);
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadTasks();
        });
    </script>
</body>

</html>